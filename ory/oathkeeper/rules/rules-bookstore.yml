- id: index
  version: v1.0.0
  upstream:
    url: http://localhost:41000
    preserve_host: true
  authenticators:
    - handler: noop
  authorizer:
    handler: allow
  mutators:
    - handler: noop
  match:
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
    url: http://localhost:8080/
  errors:
    - handler: redirect
      config:
        to: http://localhost:4455/login
        return_to_query_param: return_to
        when:
          - error:
              - unauthorized
              - forbidden

- id: admin-facing
  version: v1.0.0
  upstream:
    url: http://localhost:41000
    preserve_host: true
  authenticators:
    - handler: cookie_session
  authorizer:
    handler: remote
    config:
      headers:
        X-Subject: "{{ print .Subject }}"
        X-Email: "{{ print .Extra.identity.traits.email }}"
        X-URL: "{{ print .MatchContext.URL }}"
        X-Method: "{{ print .MatchContext.Method }}"
        X-Captured-Groups: "{{ print .MatchContext.RegexpCaptureGroups }}"
  mutators:
    - handler: noop
  match:
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
    url: http://localhost:8080/<books/?>
  errors:
    - handler: redirect
      config:
        to: http://localhost:4455/login
        return_to_query_param: return_to
        when:
          - error:
              - unauthorized
              - forbidden

- id: customer-facing
  version: v1.0.0
  upstream:
    url: http://localhost:41000
    preserve_host: true
  authenticators:
    - handler: cookie_session
  authorizer:
    handler: allow
  mutators:
    - handler: noop
  match:
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
    url: http://localhost:8080/<books>/<.+>
  errors:
    - handler: redirect
      config:
        to: http://localhost:4455/login
        return_to_query_param: return_to
        when:
          - error:
              - unauthorized
              - forbidden
